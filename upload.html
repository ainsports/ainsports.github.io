<html>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <style>
      li { cursor: pointer; }
      li:hover {
        color: rgb(41, 119, 255);
        
      }
    </style>
    <div class="container">
      <p>Upload a video for prediction. A 2-mins video should take around 10 seconds to run in the server. </p>

      <div class = "row">
        
        <div class = "col-4">
          <input type="file" class="d-none" id="addVideosInput" accept=" video/*">
          <button class="btn btn-success" id="addVideo"> Add Video </button>
          <button class="btn btn-primary" id="submit" onclick="upload()" disabled>Submit</button>
          <span id = "status"></span>
        </div>
        <div class = "col-8">
          <div class="progress">
            <div id = "upload-bar" class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
          </div>
          <div class = "progress">
            <div id = "prediction-bar" class="progress-bar progress-bar-striped bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
          </div>
        </div>
      </div>   
      <div class="row">
        <div class="col-8">
          
          <div class="video-frame">
          </div>

          <label id ="range-label" for="customRange1" class="form-label">Confidence Threshold: 0.5</label>
          <input type="range" min="1" max="10" value="5" class="form-range" id="myRange"> 

        </div>
        <div class="col-mid-4">
          <div id="timeline" style="display:inline">
            <!-- Timeline -->
            <ul id="listPred">
            </ul>
          </div>
          
        </div>
      </div>
      <div class = "row">
        
        <div class = "col-4">
          <button class="btn btn-primary" id="generate" onclick="generateSummary()">Generate</button>
        </div>
      </div>   
      <div class="row">
        <div class="col-8">
          <video width = "400" id = "video-summary" controls ></video>
        </div>
      </div>
      
    </div>

   <script>
    var timer;
    var timerSummary;
    var currTimeSummary = 0;
    var currTime = 0;  
    var endTime = 1 ; 
    var currData; 
    var slider = document.getElementById('myRange');
    var thresh = 0.5;  

    slider.onchange  = function() {
        thresh = parseFloat(this.value)/10;
        $("#range-label").html(`Confidence Threshold: ${thresh}`)
        if (currData != undefined){
          populateList(currData)
        }
    };

    $("#video-summary").hide();
    $("#generate").hide();

    $('#addVideo').click(function() {
      $(this).parents().find('#addVideosInput').click();
      $('#listPred').html("")
    });

    document.getElementById('addVideosInput').onchange = e => {
       $("#video-summary").hide();
        const file = e.target.files[0];
        const url = URL.createObjectURL(file);
        const video = `<video controls="controls" src=" ${url} " id = "video" type="video/mp4" width="400px" height="200px"></video>
            <span><i class="fa fa-trash"></i></span>`
        $('.video-frame').html(video);
        var videoElement = document.getElementById("video")
        var duration = videoElement.duration;
        
        videoElement.addEventListener('loadedmetadata', function() {
          let duration = videoElement.duration
          endTime = (duration/120)*9000
          console.log('eat in seconds ', endTime)
          $("#submit").removeAttr("disabled");
          $('#submit').removeClass('disabled');
        });
    }
    function moveVideo(timeInSeconds, _id = "#video"){
      $(_id)[0].currentTime = timeInSeconds
    }

    function enable(){
      $("#submit").removeAttr("disabled");
      $('#submit').removeClass('disabled');
      $("#addVideo").removeAttr("disabled");
      $('#addVideo').removeClass('disabled');
    }

    function disable(){
      $("#submit").attr("disabled", true);
      $('#submit').addClass('disabled');
      $("#addVideo").attr("disabled", true);
      $('#addVideo').addClass('disabled');
    }

    function updatePrediction(){
      currTime += 1000 
      let valeur = Math.round(currTime/endTime * 100)
      if (valeur <= 100){
        $('#prediction-bar').css('width', valeur+'%').attr('aria-valuenow', valeur);
        $('#prediction-bar').html(valeur+'%') 
      }else{
      }
    }

    function populateList(data){
      $('#listPred').html("")
      data.predictions.forEach(function(item) {
          var confidenceScore = parseFloat(item['confidence'])
          console.log(confidenceScore)
          var timeFormat = item['gameTime'].split('-')[1]
          const minutes = parseInt(timeFormat.split(':')[0])
          const seconds = parseInt(timeFormat.split(':')[1])
          var timeInSeconds = 60*minutes+seconds-5;
          if (confidenceScore > thresh) 
            $('#listPred').append(`<li onclick="moveVideo(${timeInSeconds})">${timeFormat} - ${item["label"]}</li>`);                                              
        });
    }
    function upload(){
      currTime = 0 
      disable()
      $("#video-summary").hide();
      $('#status').html("Uploading ...");
      var input = document.querySelector('input[type="file"]')
      var data = new FormData()
      data.append('file', input.files[0])
      var slider = document.getElementById('myRange-sample');
      thresh = parseFloat(slider.value)/10;
      console.log(thresh)
      data.append('thresh', "0.5")
      console.log(data)
      axios.request({
      method: "post", 
      url: "https://ainsports.eu.ngrok.io/recieve", 
      data: data,
      contentType: false, // NEEDED, DON'T OMIT THIS (requires jQuery 1.6+)
      processData: false, // NEEDED, DON'T OMIT THIS 
      onUploadProgress: (p) => {
        let valeur = Math.round((p.loaded / p.total)* 100)
        $('#upload-bar').css('width', valeur+'%').attr('aria-valuenow', valeur);
        $('#upload-bar').html(valeur+'%')
        if (valeur == 100){
          timer = setInterval(updatePrediction, 1000);
          $('#status').html("Predicting ...");
        }  
      }
    }) .then(function (results) {
        console.log(results)
        $('#listPred').html("")
        $('#status').html("");
        enable()
        currTime = 0
        clearInterval(timer) 
        currData = results.data
        populateList(currData)
        $("#generate").show();
      });
    }

    function updateSummary(){
      currTimeSummary += 1000 
      let valeur = Math.round(currTimeSummary/18000 * 100)
      if (valeur <= 100){
        $('#summary-bar').css('width', valeur+'%').attr('aria-valuenow', valeur);
        $('#summary-bar').html(valeur+'%') 
      }else{
        clearInterval(timerSummary)
      }
    }

    function generateSummary(){
      $("#generate").attr("disabled", true);
      $('#generate').addClass('disabled');
      $('#status').html("Summarize ... ");

      timerSummary = setInterval(updateSummary, 1000)
      var data = new FormData()
      var slider = document.getElementById('myRange-sample');
      thresh = parseFloat(slider.value)/10;
      console.log(thresh)
      data.append('thresh', thresh)
      axios.request({
      method: "post", 
      url: "https://ainsports.eu.ngrok.io/summarize", 
      data: data, 
    }) .then(function (results) {
        $("#video-summary").show();
        $('#video-summary').attr('src', results.data.video_url) 
        $("#generate").removeAttr("disabled");
        $('#generate').removeClass('disabled');
      });
    }
    </script>
</html>