<html>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<style>
  li {
    cursor: pointer;
  }

  li:hover {
    color: rgb(41, 119, 255);

  }
</style>
<div class="container">
  <p>Upload a video for prediction. A 2-min video should take around 10 seconds to run in the server.
    Feel free to download those sample videos to try out.
    [<a
      href="https://github.com/ainsports/ainsports.github.io/raw/main/2015-02-21%20-%2018-00%20Chelsea%201%20-%201%20Burnley_1_006.mp4">2-min
      video</a>]
    [<a
      href="https://drive.google.com/open?id=1BvX4qJ2pNPaAGEcr1-eHRBOx5qbKgXFs&authuser=silvio.giancola%40kaust.edu.sa&usp=drive_fs">45-min
      video</a>]
  </p>

  <div class="row">

    <div class="col-4">
      <input type="file" class="d-none" id="addVideosInput" accept=" video/*">
      <button class="btn btn-success" id="addVideo"> Add Video </button>
      <button class="btn btn-primary" id="submit" onclick="upload()" disabled>Submit</button>
      <span id="status"></span>
    </div>
    <div class="col-8">
      <div class="progress">
        <div id="upload-bar" class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 0%;"
          aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
      </div>
      <div class="progress">
        <div id="prediction-bar" class="progress-bar progress-bar-striped bg-success" role="progressbar"
          style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-8">

      <div class="video-frame">
      </div>

      <label id="range-label" for="customRange1" class="form-label">Confidence Threshold: 0.5</label>
      <input type="range" min="1" max="10" value="5" class="form-range" id="myRange">

    </div>
    <div class="col-mid-4">
      <div id="timeline" style="display:inline">
        <!-- Timeline -->
        <ul id="listPred">
        </ul>
      </div>

    </div>
  </div>
  <div class="row">

    <div class="col-4">
      <button class="btn btn-primary" id="generate" onclick="generateSummary()">Generate</button>
    </div>
  </div>
  <div class="row">
    <div class="col-8">
      <video width="400" id="video-summary" controls></video>
    </div>
  </div>

</div>

<script>
  var timer;
  var timerSummary;
  var currTimeSummary;
  var currTime;
  var endTime;
  var currData;
  var slider = document.getElementById('myRange');
  var thresh = 0.5;
  var timeStamp;
  const url = "https://f990-34-122-149-240.ngrok.io"

  resetInterface();

  slider.onchange = function () {
    thresh = parseFloat(this.value) / 10;
    $("#range-label").html(`Confidence Threshold: ${thresh}`)
    if (currData != undefined) {
      populateList(currData)
    }
  };

  $('#addVideo').click(function () {
    $(this).parents().find('#addVideosInput').click();
    $('#listPred').html("")
  });

  function resetInterface() {
    currTimeSummary = 0;
    currTime = 0;
    currData = undefined;
    timeStamp = undefined;

    $('#status').html("");
    $("#video-summary").hide();
    $("#generate").hide();
    clearInterval(timer);
    clearInterval(timerSummary);
    valeur = 0;
    $('#prediction-bar').css('width', valeur + '%').attr('aria-valuenow', valeur);
    $('#prediction-bar').html(valeur + '%')
    $('#upload-bar').css('width', valeur + '%').attr('aria-valuenow', valeur);
    $('#upload-bar').html(valeur + '%')
  }

  document.getElementById('addVideosInput').onchange = e => {
    resetInterface();
    const file = e.target.files[0];
    const url = URL.createObjectURL(file);
    const video = `<video controls="controls" src=" ${url} " id = "video" type="video/mp4" width="400px" height="200px"></video>
          <span><i class="fa fa-trash"></i></span>`
    $('.video-frame').html(video);

    var videoElement = document.getElementById("video")
    var duration = videoElement.duration;

    videoElement.addEventListener('loadedmetadata', function () {
      let duration = videoElement.duration
      endTime = (duration / 120) * 9000
      console.log('eat in seconds ', endTime)
      $("#submit").removeAttr("disabled");
      $('#submit').removeClass('disabled');
    });
  }
  function moveVideo(timeInSeconds, _id = "#video") {
    $(_id)[0].currentTime = timeInSeconds
  }

  function enable() {
    $("#submit").removeAttr("disabled");
    $('#submit').removeClass('disabled');
    $("#addVideo").removeAttr("disabled");
    $('#addVideo').removeClass('disabled');
    $("#generate").removeAttr("disabled");
    $('#generate').removeClass('disabled');
  }

  function disable() {
    $("#submit").attr("disabled", true);
    $('#submit').addClass('disabled');
    $("#addVideo").attr("disabled", true);
    $('#addVideo').addClass('disabled');
    $("#generate").attr("disabled", true);
    $('#generate').addClass('disabled');
  }

  function updatePrediction() {
    currTime += 1000
    let valeur = Math.round(currTime / endTime * 100)
    if (valeur <= 100) {
      $('#prediction-bar').css('width', valeur + '%').attr('aria-valuenow', valeur);
      $('#prediction-bar').html(valeur + '%')
    } else {
      clearInterval(timer)
      currTime = 0;
    }
  }

  function populateList(data) {
    $('#listPred').html("")
    data.predictions.forEach(function (item) {
      var confidenceScore = parseFloat(item['confidence'])
      console.log(confidenceScore)
      var timeFormat = item['gameTime'].split('-')[1]
      const minutes = parseInt(timeFormat.split(':')[0])
      const seconds = parseInt(timeFormat.split(':')[1])
      var timeInSeconds = 60 * minutes + seconds - 5;
      if (confidenceScore > thresh)
        $('#listPred').append(`<li onclick="moveVideo(${timeInSeconds})">${timeFormat} - ${item["label"]}</li>`);
    });
  }
  function upload() {
    currTime = 0
    disable()
    $("#video-summary").hide();
    $('#status').html("Uploading ...");
    var input = document.querySelector('input[type="file"]')
    var data = new FormData()
    data.append('file', input.files[0])
    var slider = document.getElementById('myRange-sample');
    console.log(thresh)
    data.append('thresh', thresh)
    console.log(data)
    axios.request({
      method: "post",
      url: url + "/recieve",
      data: data,
      contentType: false, // NEEDED, DON'T OMIT THIS (requires jQuery 1.6+)
      processData: false, // NEEDED, DON'T OMIT THIS 
      onUploadProgress: (p) => {
        let valeur = Math.round((p.loaded / p.total) * 100)
        $('#upload-bar').css('width', valeur + '%').attr('aria-valuenow', valeur);
        $('#upload-bar').html(valeur + '%')
        if (valeur == 100) {
          timer = setInterval(updatePrediction, 1000);
          $('#status').html("Predicting ...");
        }
      }
    }).then(function (results) {
      console.log(results)
      $('#listPred').html("")
      $('#status').html("");
      enable()
      currTime = 0
      clearInterval(timer)
      currData = results.data
      timeStamp = results.data.time_stamp
      console.log(timeStamp)
      populateList(currData)
      $("#generate").show();
    });
  }

  function updateSummary() {
    currTimeSummary += 1000
    let valeur = Math.round(currTimeSummary / 18000 * 100)
    if (valeur <= 100) {
      $('#summary-bar').css('width', valeur + '%').attr('aria-valuenow', valeur);
      $('#summary-bar').html(valeur + '%')
    } else {
      clearInterval(timerSummary)
    }
  }

  function generateSummary() {
    disable();

    $('#status').html("Summarize ... ");

    // timerSummary = setInterval(updateSummary, 1000)
    var data = new FormData()
    var slider = document.getElementById('myRange-sample');
    console.log(thresh)
    data.append('thresh', thresh)
    data.append('time_stamp', timeStamp)
    axios.request({
      method: "post",
      url: url + "/summarize",
      data: data,
    }).then(function (results) {
      $("#video-summary").show();
      $('#video-summary').attr('src', results.data.video_url)
      $('#status').html("");
      enable();
    });
  }
</script>

</html>